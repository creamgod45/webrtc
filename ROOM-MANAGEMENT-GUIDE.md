# æˆ¿é—´ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ç®¡ç† WebRTC è¯­éŸ³ç³»ç»Ÿä¸­çš„æˆ¿é—´ï¼ŒåŒ…æ‹¬æµè§ˆæˆ¿é—´å’Œæ¸…é™¤æˆ¿é—´æ•°æ®ã€‚

---

## ğŸ  æˆ¿é—´æµè§ˆåŠŸèƒ½

### å½“å‰å®ç°

æˆ¿é—´æµè§ˆï¼ˆå¤§å…ï¼‰åŠŸèƒ½**å·²ç»é»˜è®¤åªæ˜¾ç¤ºæ•°æ®åº“è®°å½•çš„æˆ¿é—´**ã€‚

#### æ˜¾ç¤ºæ¡ä»¶

å¤§å…åªæ˜¾ç¤ºæ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„æˆ¿é—´ï¼š
- âœ… `is_active = true` - æ´»è·ƒçš„æˆ¿é—´
- âœ… `is_private = false` - å…¬å¼€çš„æˆ¿é—´
- âœ… æ•°æ®åº“ä¸­æœ‰è®°å½•çš„æˆ¿é—´

#### ä»£ç å®ç°

**åç«¯ API** (`src/routes/rooms.js`):
```javascript
router.get('/lobby/list', async (req, res) => {
  const rooms = await Room.findAll({
    where: {
      is_active: true,      // âœ… åªæ˜¾ç¤ºæ´»è·ƒæˆ¿é—´
      is_private: false     // âœ… åªæ˜¾ç¤ºå…¬å¼€æˆ¿é—´
    },
    include: [{
      model: User,
      as: 'users',
      where: { is_connected: true },
      required: false
    }],
    order: [['created_at', 'DESC']]
  });

  res.json({ rooms: roomList });
});
```

**å‰ç«¯è°ƒç”¨** (`public/app.js`):
```javascript
async function loadLobbyRooms() {
  const response = await fetch('/api/rooms/lobby/list');
  const data = await response.json();
  displayLobbyRooms(data.rooms);
}
```

### ä½¿ç”¨æ–¹æ³•

1. ç‚¹å‡»ä¸»ç•Œé¢çš„ã€Œç€è¦½æˆ¿é–“ã€æŒ‰é’®
2. ç³»ç»Ÿè‡ªåŠ¨åŠ è½½æ•°æ®åº“ä¸­çš„å…¬å¼€æ´»è·ƒæˆ¿é—´
3. æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯ï¼š
   - æˆ¿é—´åç§°
   - å½“å‰äººæ•° / æœ€å¤§äººæ•°
   - æ˜¯å¦éœ€è¦å¯†ç 
   - åˆ›å»ºæ—¶é—´

---

## ğŸ—‘ï¸ æ¸…é™¤æˆ¿é—´æ•°æ®

### ä¸ºä»€ä¹ˆéœ€è¦æ¸…é™¤æˆ¿é—´ï¼Ÿ

- æ¸…ç†æµ‹è¯•/å¼€å‘ç¯å¢ƒçš„æµ‹è¯•æ•°æ®
- å®šæœŸæ¸…ç†è¿‡æœŸæˆ–éæ´»è·ƒçš„æˆ¿é—´
- é‡ç½®æ¼”ç¤ºç¯å¢ƒ
- æ•°æ®åº“ç»´æŠ¤å’Œä¼˜åŒ–

### æ¸…é™¤å‘½ä»¤

#### æ–¹å¼ 1: ä½¿ç”¨ npm å‘½ä»¤ï¼ˆæ¨èï¼‰

```bash
# åˆ é™¤éæ´»è·ƒæˆ¿é—´ï¼ˆå¸¦ç¡®è®¤æç¤ºï¼‰
npm run rooms:clear

# åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼ˆå¸¦ç¡®è®¤æç¤ºï¼‰
npm run rooms:clear:all

# åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼ˆè·³è¿‡ç¡®è®¤ï¼Œç”¨äºè‡ªåŠ¨åŒ–ï¼‰
npm run rooms:clear:force
```

#### æ–¹å¼ 2: ç›´æ¥è¿è¡Œè„šæœ¬

```bash
# åˆ é™¤éæ´»è·ƒæˆ¿é—´
node scripts/clear-rooms.js

# åˆ é™¤æ‰€æœ‰æˆ¿é—´
node scripts/clear-rooms.js --all

# åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼Œè·³è¿‡ç¡®è®¤
node scripts/clear-rooms.js --all --force

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
node scripts/clear-rooms.js --help
```

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1: å®‰å…¨æ¸…ç†éæ´»è·ƒæˆ¿é—´

è¿™æ˜¯æœ€å®‰å…¨çš„æ–¹å¼ï¼Œåªåˆ é™¤å·²ç»å…³é—­çš„æˆ¿é—´ï¼š

```bash
npm run rooms:clear
```

æ‰§è¡Œæ•ˆæœï¼š
```
ğŸ—‘ï¸  æ¸…é™¤æˆ¿é—´å·¥å…·

âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

ğŸ“Š æ‰¾åˆ° 3 ä¸ªæˆ¿é—´ï¼š

1. æˆ¿é—´ ID: test-room-1
   åç§°: æµ‹è¯•æˆ¿é—´ 1
   çŠ¶æ€: éæ´»è·ƒ
   ç§äºº: å¦
   ç”¨æˆ·æ•°: 0
   åˆ›å»ºäº: 2025-01-02T08:00:00.000Z

2. æˆ¿é—´ ID: test-room-2
   åç§°: æµ‹è¯•æˆ¿é—´ 2
   çŠ¶æ€: éæ´»è·ƒ
   ç§äºº: å¦
   ç”¨æˆ·æ•°: 0
   åˆ›å»ºäº: 2025-01-02T09:00:00.000Z

3. æˆ¿é—´ ID: old-meeting
   åç§°: æ—§ä¼šè®®å®¤
   çŠ¶æ€: éæ´»è·ƒ
   ç§äºº: æ˜¯
   ç”¨æˆ·æ•°: 0
   åˆ›å»ºäº: 2025-01-01T10:00:00.000Z

ğŸ“ˆ ç›¸å…³æ•°æ®ç»Ÿè®¡ï¼š
   ç”¨æˆ·è®°å½•: 8
   èŠå¤©æ¶ˆæ¯: 25
   ICE Candidates: 15
   SDP Signals: 12

âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤ä»¥ä¸‹æ•°æ®ï¼š
   - 3 ä¸ªæˆ¿é—´
   - 8 æ¡ç”¨æˆ·è®°å½•
   - 25 æ¡èŠå¤©æ¶ˆæ¯
   - 15 æ¡ ICE Candidate è®°å½•
   - 12 æ¡ SDP Signal è®°å½•

â— æ­¤æ“ä½œä¸å¯æ¢å¤ï¼

ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ (yes/no): yes

ğŸ”„ å¼€å§‹åˆ é™¤...

  åˆ é™¤ ICE Candidates...
  âœ… åˆ é™¤äº† 15 æ¡ ICE Candidate è®°å½•
  åˆ é™¤ SDP Signals...
  âœ… åˆ é™¤äº† 12 æ¡ SDP Signal è®°å½•
  åˆ é™¤èŠå¤©æ¶ˆæ¯...
  âœ… åˆ é™¤äº† 25 æ¡èŠå¤©æ¶ˆæ¯
  åˆ é™¤ç”¨æˆ·è®°å½•...
  âœ… åˆ é™¤äº† 8 æ¡ç”¨æˆ·è®°å½•
  åˆ é™¤æˆ¿é—´è®°å½•...
  âœ… åˆ é™¤äº† 3 ä¸ªæˆ¿é—´

âœ… åˆ é™¤å®Œæˆï¼

ğŸ“Š æ€»ç»“ï¼š
   - åˆ é™¤äº† 3 ä¸ªæˆ¿é—´
   - åˆ é™¤äº† 8 æ¡ç”¨æˆ·è®°å½•
   - åˆ é™¤äº† 25 æ¡èŠå¤©æ¶ˆæ¯
   - åˆ é™¤äº† 15 æ¡ ICE Candidate è®°å½•
   - åˆ é™¤äº† 12 æ¡ SDP Signal è®°å½•
```

#### ç¤ºä¾‹ 2: æ¸…ç©ºæ‰€æœ‰æˆ¿é—´

âš ï¸ **è­¦å‘Š**: è¿™ä¼šåˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼ŒåŒ…æ‹¬æ´»è·ƒçš„æˆ¿é—´ï¼

```bash
npm run rooms:clear:all
```

ç³»ç»Ÿä¼šæ˜¾ç¤ºæ‰€æœ‰æˆ¿é—´ï¼ˆåŒ…æ‹¬æ´»è·ƒçš„ï¼‰ï¼Œå¹¶è¦æ±‚ç¡®è®¤ã€‚

#### ç¤ºä¾‹ 3: è‡ªåŠ¨åŒ–æ¸…ç†ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

å¦‚æœéœ€è¦åœ¨è‡ªåŠ¨åŒ–è„šæœ¬ä¸­ä½¿ç”¨ï¼ˆä¾‹å¦‚å®šæ—¶ä»»åŠ¡ï¼‰ï¼Œå¯ä»¥è·³è¿‡ç¡®è®¤æç¤ºï¼š

```bash
npm run rooms:clear:force
```

---

## ğŸ“Š æ¸…é™¤çš„æ•°æ®èŒƒå›´

æ¸…é™¤æˆ¿é—´æ—¶ï¼Œä¼šåŒæ—¶åˆ é™¤ä»¥ä¸‹ç›¸å…³æ•°æ®ï¼š

| æ•°æ®ç±»å‹ | è¡¨å | è¯´æ˜ |
|---------|------|------|
| æˆ¿é—´è®°å½• | `rooms` | æˆ¿é—´çš„åŸºæœ¬ä¿¡æ¯ |
| ç”¨æˆ·è®°å½• | `users` | æˆ¿é—´ä¸­çš„ç”¨æˆ·è¿æ¥è®°å½• |
| èŠå¤©æ¶ˆæ¯ | `messages` | æˆ¿é—´çš„èŠå¤©å†å² |
| ICE Candidates | `ice_candidates` | WebRTC è¿æ¥çš„ ICE å€™é€‰ |
| SDP Signals | `sdp_signals` | WebRTC ä¿¡ä»¤æ•°æ® |

### åˆ é™¤é¡ºåº

ä¸ºäº†é¿å…å¤–é”®çº¦æŸé”™è¯¯ï¼Œåˆ é™¤é¡ºåºä¸ºï¼š
1. ICE Candidates
2. SDP Signals
3. Messages
4. Users
5. Rooms

æ‰€æœ‰åˆ é™¤æ“ä½œåœ¨ä¸€ä¸ª**äº‹åŠ¡**ä¸­æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ•°æ®å®‰å…¨

1. **ä¸å¯æ¢å¤**: åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…ä½¿ç”¨
2. **å»ºè®®å¤‡ä»½**: åœ¨æ‰§è¡Œåˆ é™¤å‰å»ºè®®å¤‡ä»½æ•°æ®åº“
3. **ç”Ÿäº§ç¯å¢ƒ**: åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¯·ä¸‰æ€

### å¤‡ä»½æ•°æ®åº“

åœ¨æ‰§è¡Œæ¸…é™¤æ“ä½œå‰ï¼Œå»ºè®®å…ˆå¤‡ä»½æ•°æ®åº“ï¼š

```bash
# å¤‡ä»½ PostgreSQL æ•°æ®åº“
pg_dump -U your_username -d webrtc_voice > backup_$(date +%Y%m%d_%H%M%S).sql

# å¦‚æœéœ€è¦æ¢å¤
psql -U your_username -d webrtc_voice < backup_20250102_150000.sql
```

### ä½¿ç”¨å»ºè®®

| åœºæ™¯ | æ¨èå‘½ä»¤ | è¯´æ˜ |
|------|---------|------|
| å¼€å‘ç¯å¢ƒæ—¥å¸¸æ¸…ç† | `npm run rooms:clear` | å®‰å…¨ï¼Œåªåˆ é™¤éæ´»è·ƒæˆ¿é—´ |
| æµ‹è¯•ç¯å¢ƒé‡ç½® | `npm run rooms:clear:all` | å¸¦ç¡®è®¤æç¤º |
| è‡ªåŠ¨åŒ–å®šæ—¶æ¸…ç† | `npm run rooms:clear:force` | è·³è¿‡ç¡®è®¤ï¼Œé€‚åˆè„šæœ¬ |
| ç”Ÿäº§ç¯å¢ƒ | ä¸æ¨è | æˆ–ä½¿ç”¨ `rooms:clear` ä¸”å…ˆå¤‡ä»½ |

---

## ğŸ”§ å®šæœŸæ¸…ç†è®¾ç½®

### Linux/Mac å®šæ—¶ä»»åŠ¡ (cron)

ç¼–è¾‘ crontabï¼š
```bash
crontab -e
```

æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼š
```bash
# æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ¸…ç†éæ´»è·ƒæˆ¿é—´
0 3 * * * cd /path/to/webrtc && npm run rooms:clear:force >> /var/log/room-cleanup.log 2>&1

# æ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹æ¸…ç†æ‰€æœ‰æˆ¿é—´ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
0 2 * * 0 cd /path/to/webrtc && npm run rooms:clear:all >> /var/log/room-cleanup.log 2>&1
```

### Windows å®šæ—¶ä»»åŠ¡

åˆ›å»º PowerShell è„šæœ¬ `clear-rooms.ps1`:
```powershell
cd C:\path\to\webrtc
npm run rooms:clear:force
```

ä½¿ç”¨ä»»åŠ¡è®¡åˆ’ç¨‹åºï¼ˆTask Schedulerï¼‰è®¾ç½®å®šæ—¶æ‰§è¡Œã€‚

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜ 1: "Cannot find module"

**åŸå› **: æœªå®‰è£…ä¾èµ–

**è§£å†³æ–¹æ¡ˆ**:
```bash
npm install
```

### é—®é¢˜ 2: "Unable to connect to the database"

**åŸå› **: æ•°æ®åº“è¿æ¥é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `.env` æ–‡ä»¶é…ç½®
2. ç¡®ä¿ PostgreSQL æœåŠ¡æ­£åœ¨è¿è¡Œ
3. éªŒè¯æ•°æ®åº“å‡­æ®

```bash
# æŸ¥çœ‹ .env æ–‡ä»¶
cat .env

# æ£€æŸ¥ PostgreSQL æœåŠ¡çŠ¶æ€
# Windows
services.msc  # æŸ¥æ‰¾ PostgreSQL

# Linux/Mac
sudo systemctl status postgresql
```

### é—®é¢˜ 3: "Foreign key constraint failed"

**åŸå› **: æ•°æ®åº“å¤–é”®çº¦æŸé…ç½®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
1. è„šæœ¬å·²ç»æŒ‰æ­£ç¡®é¡ºåºåˆ é™¤ï¼Œä¸åº”å‡ºç°æ­¤é”™è¯¯
2. å¦‚æœä»ç„¶å‡ºç°ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹æ­£åœ¨ä½¿ç”¨è¿™äº›è®°å½•
3. æ£€æŸ¥æ•°æ®åº“å¤–é”®çº¦æŸé…ç½®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“ Schema è¯´æ˜](./src/database/migrations/README.md)
- [æ¸…é™¤è„šæœ¬è¯¦ç»†è¯´æ˜](./scripts/README.md)
- [é¡¹ç›®ä¸»æ–‡æ¡£](./CLAUDE.md)
- [API æ¥å£æ–‡æ¡£](./README.md)

---

## ğŸ” å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æˆ¿é—´æµè§ˆ API
curl http://localhost:3000/api/rooms/lobby/list

# åˆ é™¤éæ´»è·ƒæˆ¿é—´ï¼ˆå®‰å…¨ï¼‰
npm run rooms:clear

# æŸ¥çœ‹å¸®åŠ©
node scripts/clear-rooms.js --help

# å¤‡ä»½æ•°æ®åº“
pg_dump -U your_user -d webrtc_voice > backup.sql
```

### æˆ¿é—´çŠ¶æ€è¯´æ˜

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|---|------|
| `is_active` | `true` | æˆ¿é—´æ´»è·ƒï¼Œæ˜¾ç¤ºåœ¨å¤§å… |
| `is_active` | `false` | æˆ¿é—´å…³é—­ï¼Œä¸æ˜¾ç¤ºåœ¨å¤§å… |
| `is_private` | `true` | ç§äººæˆ¿é—´ï¼Œä¸æ˜¾ç¤ºåœ¨å¤§å… |
| `is_private` | `false` | å…¬å¼€æˆ¿é—´ï¼Œå¯åœ¨å¤§å…æ˜¾ç¤º |

---

**åˆ›å»ºæ—¥æœŸ**: 2025-01-02
**æœ€åæ›´æ–°**: 2025-01-02
**ç‰ˆæœ¬**: 1.0.0
