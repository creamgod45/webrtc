# æ•°æ®åº“ç®¡ç†è„šæœ¬

æ­¤ç›®å½•åŒ…å«ç”¨äºç®¡ç†æ•°æ®åº“çš„å®ç”¨è„šæœ¬ã€‚

## ğŸ“‚ è„šæœ¬åˆ—è¡¨

### clear-rooms.js - æ¸…é™¤æˆ¿é—´è®°å½•

ç”¨äºæ¸…é™¤æ•°æ®åº“ä¸­çš„æˆ¿é—´åŠå…¶ç›¸å…³æ•°æ®ã€‚

#### ä½¿ç”¨æ–¹æ³•

```bash
# æ–¹å¼ 1: ä½¿ç”¨ npm å‘½ä»¤ï¼ˆæ¨èï¼‰
npm run rooms:clear              # åˆ é™¤éæ´»è·ƒæˆ¿é—´ï¼ˆå¸¦ç¡®è®¤æç¤ºï¼‰
npm run rooms:clear:all          # åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼ˆå¸¦ç¡®è®¤æç¤ºï¼‰
npm run rooms:clear:force        # åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼ˆè·³è¿‡ç¡®è®¤ï¼‰

# æ–¹å¼ 2: ç›´æ¥è¿è¡Œè„šæœ¬
node scripts/clear-rooms.js                    # åˆ é™¤éæ´»è·ƒæˆ¿é—´
node scripts/clear-rooms.js --all             # åˆ é™¤æ‰€æœ‰æˆ¿é—´
node scripts/clear-rooms.js --all --force     # åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼Œè·³è¿‡ç¡®è®¤
node scripts/clear-rooms.js --help            # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

#### é€‰é¡¹è¯´æ˜

| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| `--all` | åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼ˆåŒ…æ‹¬æ´»è·ƒå’Œéæ´»è·ƒï¼‰ |
| `--inactive` | åªåˆ é™¤éæ´»è·ƒæˆ¿é—´ï¼ˆé»˜è®¤ï¼‰ |
| `--force` | è·³è¿‡ç¡®è®¤æç¤ºï¼Œç›´æ¥åˆ é™¤ |
| `--help`, `-h` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ |

#### åˆ é™¤çš„æ•°æ®

æ­¤è„šæœ¬ä¼šåˆ é™¤ä»¥ä¸‹æ•°æ®ï¼š
- âœ… æˆ¿é—´è®°å½• (rooms)
- âœ… ç”¨æˆ·è®°å½• (users)
- âœ… èŠå¤©æ¶ˆæ¯ (messages)
- âœ… ICE Candidates (ice_candidates)
- âœ… SDP Signals (sdp_signals)

#### ä½¿ç”¨ç¤ºä¾‹

**ç¤ºä¾‹ 1: æ¸…ç†æµ‹è¯•æˆ¿é—´ï¼ˆå®‰å…¨ï¼‰**
```bash
# åªåˆ é™¤éæ´»è·ƒçš„æˆ¿é—´ï¼Œä¼šæ˜¾ç¤ºç¡®è®¤æç¤º
npm run rooms:clear
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ—‘ï¸  æ¸…é™¤æˆ¿é—´å·¥å…·

âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

ğŸ“Š æ‰¾åˆ° 5 ä¸ªæˆ¿é—´ï¼š

1. æˆ¿é—´ ID: test-room-1
   åç§°: æµ‹è¯•æˆ¿é—´ 1
   çŠ¶æ€: éæ´»è·ƒ
   ç§äºº: å¦
   ç”¨æˆ·æ•°: 0
   åˆ›å»ºäº: 2025-01-02T10:00:00.000Z

...

ğŸ“ˆ ç›¸å…³æ•°æ®ç»Ÿè®¡ï¼š
   ç”¨æˆ·è®°å½•: 12
   èŠå¤©æ¶ˆæ¯: 45
   ICE Candidates: 23
   SDP Signals: 18

âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤ä»¥ä¸‹æ•°æ®ï¼š
   - 5 ä¸ªæˆ¿é—´
   - 12 æ¡ç”¨æˆ·è®°å½•
   - 45 æ¡èŠå¤©æ¶ˆæ¯
   - 23 æ¡ ICE Candidate è®°å½•
   - 18 æ¡ SDP Signal è®°å½•

â— æ­¤æ“ä½œä¸å¯æ¢å¤ï¼

ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ (yes/no):
```

**ç¤ºä¾‹ 2: æ¸…ç©ºæ‰€æœ‰æˆ¿é—´ï¼ˆæ…ç”¨ï¼‰**
```bash
# åˆ é™¤æ‰€æœ‰æˆ¿é—´ï¼ŒåŒ…æ‹¬æ´»è·ƒçš„æˆ¿é—´
npm run rooms:clear:all
```

**ç¤ºä¾‹ 3: è‡ªåŠ¨åŒ–æ¸…ç†ï¼ˆç”¨äºè„šæœ¬ï¼‰**
```bash
# è·³è¿‡ç¡®è®¤æç¤ºï¼Œç›´æ¥åˆ é™¤æ‰€æœ‰æˆ¿é—´
npm run rooms:clear:force
```

#### âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸å¯æ¢å¤**: åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…ä½¿ç”¨
2. **å»ºè®®å¤‡ä»½**: åœ¨æ‰§è¡Œåˆ é™¤å‰å»ºè®®å¤‡ä»½æ•°æ®åº“
3. **ç”Ÿäº§ç¯å¢ƒ**: åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¯·ä¸‰æ€
4. **äº‹åŠ¡ä¿æŠ¤**: æ‰€æœ‰åˆ é™¤æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š

#### é€‚ç”¨åœºæ™¯

- âœ… æ¸…ç†å¼€å‘/æµ‹è¯•ç¯å¢ƒçš„æµ‹è¯•æ•°æ®
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸæˆ–éæ´»è·ƒçš„æˆ¿é—´
- âœ… é‡ç½®æ¼”ç¤ºç¯å¢ƒ
- âŒ ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒé¢‘ç¹ä½¿ç”¨

---

## ğŸ›¡ï¸ å®‰å…¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ­¤è„šæœ¬ï¼š

1. **å¤‡ä»½æ•°æ®åº“**
   ```bash
   pg_dump -U your_user -d webrtc_voice > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **ä½¿ç”¨ç¡®è®¤æç¤º**
   ```bash
   # ä¸è¦ä½¿ç”¨ --force é€‰é¡¹
   npm run rooms:clear:all
   ```

3. **æµ‹è¯•æ¢å¤æµç¨‹**
   ```bash
   # ç¡®ä¿å¯ä»¥ä»å¤‡ä»½æ¢å¤
   psql -U your_user -d webrtc_voice < backup.sql
   ```

### å®šæœŸæ¸…ç†å»ºè®®

å¯ä»¥è®¾ç½®å®šæœŸä»»åŠ¡ï¼ˆcron jobï¼‰æ¸…ç†éæ´»è·ƒæˆ¿é—´ï¼š

```bash
# æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ¸…ç†éæ´»è·ƒæˆ¿é—´
0 3 * * * cd /path/to/webrtc && npm run rooms:clear:force
```

---

## ğŸ“ å¼€å‘ç¬”è®°

### è„šæœ¬ç»“æ„

```javascript
// 1. å‚æ•°è§£æ
const options = {
  all: args.includes('--all'),
  inactive: args.includes('--inactive'),
  force: args.includes('--force')
};

// 2. æŸ¥è¯¢æˆ¿é—´
const rooms = await Room.findAll({ where: whereClause });

// 3. æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
console.log(`æ‰¾åˆ° ${roomCount} ä¸ªæˆ¿é—´`);

// 4. ç¡®è®¤åˆ é™¤
if (!options.force) {
  const confirmed = await askConfirmation('ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
}

// 5. äº‹åŠ¡åˆ é™¤
await sequelize.transaction(async (t) => {
  // æŒ‰ç…§å¤–é”®ä¾èµ–é¡ºåºåˆ é™¤
  await IceCandidate.destroy({ where: { room_id: roomIds }, transaction: t });
  await SdpSignal.destroy({ where: { room_id: roomIds }, transaction: t });
  await Message.destroy({ where: { room_id: roomIds }, transaction: t });
  await User.destroy({ where: { room_id: roomIds }, transaction: t });
  await Room.destroy({ where: whereClause, transaction: t });
});
```

### åˆ é™¤é¡ºåº

ä¸ºäº†é¿å…å¤–é”®çº¦æŸé”™è¯¯ï¼Œåˆ é™¤é¡ºåºä¸ºï¼š
1. ICE Candidatesï¼ˆæ— å¤–é”®ä¾èµ–ï¼‰
2. SDP Signalsï¼ˆæ— å¤–é”®ä¾èµ–ï¼‰
3. Messagesï¼ˆä¾èµ– room_idï¼‰
4. Usersï¼ˆä¾èµ– room_idï¼‰
5. Roomsï¼ˆè¢«ä»¥ä¸Šæ‰€æœ‰è¡¨ä¾èµ–ï¼‰

---

## ğŸ”§ æ•…éšœæ’é™¤

### é”™è¯¯: "Cannot find module"

ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š
```bash
npm install
```

### é”™è¯¯: "Unable to connect to the database"

æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®ï¼š
```bash
cat .env
```

ç¡®ä¿ PostgreSQL æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
```bash
# Windows
services.msc  # æŸ¥æ‰¾ PostgreSQL æœåŠ¡

# Linux/Mac
sudo systemctl status postgresql
```

### é”™è¯¯: "Foreign key constraint"

å¦‚æœå‡ºç°å¤–é”®çº¦æŸé”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹æ­£åœ¨ä½¿ç”¨è¿™äº›æˆ¿é—´
2. æ•°æ®åº“æ˜¯å¦æœ‰çº§è”åˆ é™¤é…ç½®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“ Schema](../src/database/migrations/README.md)
- [API æ–‡æ¡£](../CLAUDE.md)
- [é¡¹ç›® README](../README.md)

---

**åˆ›å»ºæ—¥æœŸ**: 2025-01-02
**æœ€åæ›´æ–°**: 2025-01-02
